<div class="allocations-container">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">Resource Allocation Management</h2>
      <p class="text-muted mb-0">Manage weekly project allocations for employees</p>
    </div>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <i class="bi bi-plus-circle me-2"></i>
      New Allocation
    </button>
  </div>

  <!-- Week Navigation -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <button class="btn btn-outline-secondary" (click)="onWeekChange('prev')">
          <i class="bi bi-chevron-left"></i>
          Previous Week
        </button>
        
        <div class="text-center">
          <h5 class="mb-0">Week of {{ currentWeekStart() | date:'mediumDate' }} - {{ weekEndDate() | date:'mediumDate' }}</h5>
          <small class="text-muted">{{ currentWeekStart() | date:'EEEE' }} to {{ weekEndDate() | date:'EEEE' }}</small>
        </div>
        
        <button class="btn btn-outline-secondary" (click)="onWeekChange('next')">
          Next Week
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- View Mode Tabs -->
  <div class="card mb-4">
    <div class="card-header border-bottom-0">
      <ul class="nav nav-tabs card-header-tabs">
        <li class="nav-item">
          <button 
            class="nav-link"
            [class.active]="viewMode() === 'overview'"
            (click)="onViewModeChange('overview')">
            <i class="bi bi-grid-3x3-gap me-2"></i>
            Overview
          </button>
        </li>
        <li class="nav-item">
          <button 
            class="nav-link"
            [class.active]="viewMode() === 'project'"
            (click)="onViewModeChange('project')">
            <i class="bi bi-briefcase me-2"></i>
            By Project
          </button>
        </li>
        <li class="nav-item">
          <button 
            class="nav-link"
            [class.active]="viewMode() === 'employee'"
            (click)="onViewModeChange('employee')">
            <i class="bi bi-people me-2"></i>
            By Employee
          </button>
        </li>
      </ul>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading()" class="text-center p-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Overview Mode -->
  <div *ngIf="!isLoading() && viewMode() === 'overview'">
    <!-- Summary Cards -->
    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <div class="card border-start border-4 border-primary">
          <div class="card-body">
            <h6 class="card-title">Total Allocations</h6>
            <h3 class="text-primary">{{ allocations().length }}</h3>
            <small class="text-muted">This week</small>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card border-start border-4 border-success">
          <div class="card-body">
            <h6 class="card-title">Total Hours Allocated</h6>
            <h3 class="text-success">
              {{ getTotalAllocatedHours() }}
            </h3>
            <small class="text-muted">Hours this week</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Project Summary -->
    <div class="row">
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header">
            <h6 class="card-title mb-0">Projects Summary</h6>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Project</th>
                    <th class="text-center">Employees</th>
                    <th class="text-center">Hours</th>
                    <th class="text-center">Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let project of projectSummary()">
                    <td>
                      <div class="fw-medium">{{ project.projectName }}</div>
                      <small class="text-muted">{{ project.utilizationPercentage }}% utilized</small>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-secondary">{{ project.totalEmployees }}</span>
                    </td>
                    <td class="text-center">{{ project.totalAllocatedHours }}h</td>
                    <td class="text-center">
                      <button 
                        class="btn btn-sm btn-outline-primary"
                        (click)="onProjectSelect(project.projectId)">
                        View Details
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header">
            <h6 class="card-title mb-0">Employees Summary</h6>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Employee</th>
                    <th class="text-center">Projects</th>
                    <th class="text-center">Hours</th>
                    <th class="text-center">Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let employee of employeeSummary()">
                    <td>
                      <div class="fw-medium">{{ employee.userName }}</div>
                      <small class="text-muted">{{ employee.utilizationPercentage }}% capacity</small>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-info">{{ employee.totalProjects }}</span>
                    </td>
                    <td class="text-center">{{ employee.totalAllocatedHours }}h</td>
                    <td class="text-center">
                      <button 
                        class="btn btn-sm btn-outline-primary"
                        (click)="onEmployeeSelect(employee.userId)">
                        View Details
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Project View Mode -->
  <div *ngIf="!isLoading() && viewMode() === 'project'">
    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="card-title mb-0">Project Allocations</h6>
          <div>
            <select class="form-select" [(ngModel)]="selectedProjectId" (ngModelChange)="onProjectSelect($event)">
              <option value="">Select a project...</option>
              <option *ngFor="let project of availableProjects()" [value]="project.projectId">
                {{ project.projectName }}
              </option>
            </select>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <div *ngIf="selectedProjectId() && filteredAllocations().length === 0" class="text-center p-4">
          <i class="bi bi-inbox text-muted fs-1"></i>
          <p class="text-muted mt-2 mb-0">No allocations found for this project</p>
        </div>
        
        <div *ngIf="selectedProjectId() && filteredAllocations().length > 0" class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Employee</th>
                <th class="text-center">Allocated Hours</th>
                <th class="text-center">Utilization</th>
                <th class="text-center">Status</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let allocation of filteredAllocations()">
                <td>
                  <div class="fw-medium">{{ allocation.userName }}</div>
                  <small class="text-muted">{{ allocation.weekStartDate | date:'shortDate' }} - {{ allocation.weekEndDate | date:'shortDate' }}</small>
                </td>
                <td class="text-center">{{ allocation.allocatedHours }}h</td>
                <td class="text-center">
                  <span [class]="getUtilizationBadgeClass(allocation.utilizationPercentage)">
                    {{ allocation.utilizationPercentage }}%
                  </span>
                </td>
                <td class="text-center">
                  <span [class]="getStatusBadgeClass(allocation.status)">
                    {{ allocation.status }}
                  </span>
                </td>
                <td class="text-center">
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" (click)="openEditModal(allocation)">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-danger" (click)="deleteAllocation(allocation)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Employee View Mode -->
  <div *ngIf="!isLoading() && viewMode() === 'employee'">
    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="card-title mb-0">Employee Allocations</h6>
          <div>
            <select class="form-select" [(ngModel)]="selectedUserId" (ngModelChange)="onEmployeeSelect($event)">
              <option value="">Select an employee...</option>
              <option *ngFor="let employee of availableEmployees()" [value]="employee.userId">
                {{ employee.userName }}
              </option>
            </select>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <div *ngIf="selectedUserId() && filteredAllocations().length === 0" class="text-center p-4">
          <i class="bi bi-inbox text-muted fs-1"></i>
          <p class="text-muted mt-2 mb-0">No allocations found for this employee</p>
        </div>
        
        <div *ngIf="selectedUserId() && filteredAllocations().length > 0" class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Project</th>
                <th class="text-center">Allocated Hours</th>
                <th class="text-center">Utilization</th>
                <th class="text-center">Status</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let allocation of filteredAllocations()">
                <td>
                  <div class="fw-medium">{{ allocation.projectName }}</div>
                  <small class="text-muted">{{ allocation.weekStartDate | date:'shortDate' }} - {{ allocation.weekEndDate | date:'shortDate' }}</small>
                </td>
                <td class="text-center">{{ allocation.allocatedHours }}h</td>
                <td class="text-center">
                  <span [class]="getUtilizationBadgeClass(allocation.utilizationPercentage)">
                    {{ allocation.utilizationPercentage }}%
                  </span>
                </td>
                <td class="text-center">
                  <span [class]="getStatusBadgeClass(allocation.status)">
                    {{ allocation.status }}
                  </span>
                </td>
                <td class="text-center">
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" (click)="openEditModal(allocation)">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-danger" (click)="deleteAllocation(allocation)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal fade" [class.show]="showCreateModal()" [style.display]="showCreateModal() ? 'block' : 'none'" 
     tabindex="-1" role="dialog" [attr.aria-hidden]="!showCreateModal()">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ editingAllocation() ? 'Edit Allocation' : 'Create New Allocation' }}
        </h5>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
      </div>
      <form [formGroup]="allocationForm" (ngSubmit)="onSubmit()">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Project *</label>
                <select class="form-select" formControlName="projectId" [disabled]="!!editingAllocation()">
                  <option value="">Select a project...</option>
                  <option *ngFor="let project of availableProjects()" [value]="project.projectId">
                    {{ project.projectName }}
                  </option>
                </select>
                <div class="invalid-feedback" 
                     *ngIf="allocationForm.get('projectId')?.invalid && allocationForm.get('projectId')?.touched">
                  Project is required
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Employee *</label>
                <select class="form-select" formControlName="userId" [disabled]="!!editingAllocation()">
                  <option value="">Select an employee...</option>
                  <option *ngFor="let employee of availableEmployees()" [value]="employee.userId">
                    {{ employee.userName }}
                  </option>
                </select>
                <div class="invalid-feedback" 
                     *ngIf="allocationForm.get('userId')?.invalid && allocationForm.get('userId')?.touched">
                  Employee is required
                </div>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Allocated Hours *</label>
                <input type="number" class="form-control" formControlName="allocatedHours" 
                       min="1" max="67.5" step="0.5" placeholder="Enter hours">
                <div class="form-text">Standard: 45 hours (9 hrs/day × 5 days). Max: 67.5 hours (reasonable overtime)</div>
                <div class="invalid-feedback" 
                     *ngIf="allocationForm.get('allocatedHours')?.invalid && allocationForm.get('allocatedHours')?.touched">
                  Please enter valid hours (1-67.5)
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Week Period</label>
                <input type="text" class="form-control" readonly 
                       [value]="currentWeekStart() + ' to ' + weekEndDate()">
                <div class="form-text">Week period for this allocation</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="allocationForm.invalid">
            {{ editingAllocation() ? 'Update Allocation' : 'Create Allocation' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade" [class.show]="showCreateModal()" *ngIf="showCreateModal()"></div>
