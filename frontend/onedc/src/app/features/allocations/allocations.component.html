<div class="allocations-page">
<div class="allocations-container">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">Resource Allocation Management</h2>
      <p class="text-muted mb-0">Manage weekly project allocations for employees</p>
    </div>
    
    <!-- Week Selection and New Allocation -->
    <div class="d-flex align-items-center gap-4">
      <!-- Week Navigation -->
      <div class="d-flex align-items-center gap-3">
        <button class="btn btn-outline-secondary btn-sm" (click)="onWeekChange('prev')" title="Previous Week">
          <i class="bi bi-chevron-left"></i>
        </button>
        
        <!-- From Date -->
        <div class="d-flex flex-column" style="margin-top: -25px;">
          <label class="form-label mb-1 text-muted small">From Date</label>
          <input 
            type="date" 
            class="form-control form-control-sm" 
            [value]="formatCurrentWeekStart()" 
            (change)="onWeekDateChange($event)"
            style="width: 140px;">
        </div>
        
        <!-- To Date -->
        <div class="d-flex flex-column" style="margin-top: -25px;">
          <label class="form-label mb-1 text-muted small">To Date</label>
          <input 
            type="date" 
            class="form-control form-control-sm" 
            [value]="formatCurrentWeekEnd()" 
            readonly
            style="width: 140px; background-color: #f8f9fa;">
        </div>
        
        <button class="btn btn-outline-secondary btn-sm" (click)="onWeekChange('next')" title="Next Week">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
      
      <!-- Action Buttons -->
      <div class="d-flex gap-2">
        <button 
          class="btn btn-success" 
          (click)="openExportModal()">
          <i class="bi bi-download me-2"></i>
          Export CSV
        </button>
        <button 
          *ngIf="canCreateOrEdit()"
          class="btn btn-primary" 
          (click)="openCreateModal()">
          <i class="bi bi-plus-circle me-2"></i>
          New Allocation
        </button>
      </div>
    </div>
  </div>



  <!-- View Mode Tabs -->
  <div class="card mb-4">
    <div class="card-header border-bottom-0">
      <ul class="nav nav-tabs card-header-tabs">
        <li class="nav-item">
          <button 
            class="nav-link"
            [class.active]="viewMode() === 'overview'"
            (click)="onViewModeChange('overview')">
            <i class="bi bi-grid-3x3-gap me-2"></i>
            Overview
          </button>
        </li>
        <li class="nav-item">
          <button 
            class="nav-link"
            [class.active]="viewMode() === 'project'"
            (click)="onViewModeChange('project')">
            <i class="bi bi-briefcase me-2"></i>
            By Project
          </button>
        </li>
        <li class="nav-item">
          <button 
            class="nav-link"
            [class.active]="viewMode() === 'employee'"
            (click)="onViewModeChange('employee')">
            <i class="bi bi-people me-2"></i>
            By Employee
          </button>
        </li>
      </ul>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading()" class="text-center p-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Overview Mode -->
  <div *ngIf="!isLoading() && viewMode() === 'overview'">
    <!-- Project Summary -->
    <div class="row">
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header">
            <h6 class="card-title mb-0">Projects Summary</h6>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Project</th>
                    <th class="text-center">Employees</th>
                    <th class="text-center">Hours</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let project of projectSummary()" 
                      class="cursor-pointer" 
                      (click)="onProjectSelect(project.projectId)"
                      title="Click to view project details">
                    <td>
                      <div class="fw-medium">{{ project.projectName }}</div>
                      <small class="text-muted">{{ project.utilizationPercentage }}% utilized</small>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-secondary">{{ project.totalEmployees }}</span>
                    </td>
                    <td class="text-center">{{ project.totalAllocatedHours }}h</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header">
            <h6 class="card-title mb-0">Employees Summary</h6>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Employee</th>
                    <th class="text-center">Projects</th>
                    <th class="text-center">Hours</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let employee of employeeSummary()" 
                      class="cursor-pointer" 
                      (click)="onEmployeeSelect(employee.userId)"
                      title="Click to view employee details">
                    <td>
                      <div class="fw-medium">{{ employee.userName }}</div>
                      <small class="text-muted">{{ employee.utilizationPercentage }}% capacity</small>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-info">{{ employee.totalProjects }}</span>
                    </td>
                    <td class="text-center">{{ employee.totalAllocatedHours }}h</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Project View Mode -->
  <div *ngIf="!isLoading() && viewMode() === 'project'">
    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-title mb-1">Project Allocations</h6>
            <small class="text-muted">
              <i class="bi bi-calendar-week me-1"></i>
              Week: {{ formatCurrentWeekStart() }} - {{ formatCurrentWeekEnd() }}
            </small>
          </div>
          <div style="width: 300px;">
            <ng-select 
              [ngModel]="selectedProjectId()" 
              (ngModelChange)="onProjectSelect($event)"
              placeholder="Search and select a project..."
              [clearable]="true"
              [searchable]="true"
              bindLabel="displayName"
              bindValue="projectId"
              [items]="availableProjectsWithDisplayName()">
              <ng-option *ngFor="let project of availableProjectsWithDisplayName()" [value]="project.projectId">
                <span>{{ project.projectName }} <small class="text-muted">- {{ project.clientName }}</small></span>
              </ng-option>
            </ng-select>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <!-- Project Summary for Selected Week -->
        <div *ngIf="selectedProjectId()" class="p-3 border-bottom bg-light">
          <div class="row text-center">
            <div class="col-md-4">
              <div class="fw-bold text-primary fs-5">{{ getProjectTotalAllocatedHours() }}h</div>
              <small class="text-muted">Total Allocated Hours</small>
            </div>
            <div class="col-md-4">
              <div class="fw-bold text-info fs-5">{{ getProjectEmployeeCount() }}</div>
              <small class="text-muted">Allocated Employees</small>
            </div>
            <div class="col-md-4">
              <div class="fw-bold text-success fs-5">{{ getProjectAverageUtilization() }}%</div>
              <small class="text-muted">Average Employee Utilization</small>
            </div>
          </div>
          <!-- <div class="mt-2 text-center">
            <small class="text-muted">
              <i class="bi bi-calendar-week me-1"></i>
              Week: {{ formatCurrentWeekStart() }} - {{ formatCurrentWeekEnd() }}
            </small>
          </div> -->
        </div>
        
        <div *ngIf="selectedProjectId() && filteredAllocations().length === 0" class="text-center p-4">
          <i class="bi bi-inbox text-muted fs-1"></i>
          <p class="text-muted mt-2 mb-0">No allocations found for this project</p>
        </div>
        
        <div *ngIf="selectedProjectId() && filteredAllocations().length > 0" class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Employee</th>
                <th class="text-center">Allocated Hours</th>
                <th class="text-center">Status</th>
                <th *ngIf="canCreateOrEdit()" class="text-center actions-column">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let allocation of filteredAllocations()">
                <td>
                  <div class="fw-medium">{{ allocation.userName }}</div>
                </td>
                <td class="text-center">{{ allocation.allocatedHours }}h</td>
                <td class="text-center">
                  <span [class]="getStatusBadgeClass(allocation.status)">
                    {{ allocation.status }}
                  </span>
                </td>
                <td *ngIf="canCreateOrEdit()" class="text-center align-middle">
                  <div class="btn-group btn-group-sm" role="group" aria-label="Actions">
                    <button 
                      type="button"
                      class="btn btn-outline-primary" 
                      (click)="openEditModal(allocation)"
                      title="Edit allocation">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button 
                      type="button"
                      class="btn btn-outline-danger" 
                      (click)="deleteAllocation(allocation)"
                      title="Delete allocation">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Employee View Mode -->
  <div *ngIf="!isLoading() && viewMode() === 'employee'">
    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-title mb-1">Employee Allocations</h6>
            <small class="text-muted">
              <i class="bi bi-calendar-week me-1"></i>
              Week: {{ formatCurrentWeekStart() }} - {{ formatCurrentWeekEnd() }}
            </small>
          </div>
          <div style="width: 300px;">
            <ng-select 
              [ngModel]="selectedUserId()" 
              (ngModelChange)="onEmployeeSelect($event)"
              placeholder="Search and select an employee..."
              [clearable]="true"
              [searchable]="true"
              bindLabel="userName"
              bindValue="userId"
              [items]="availableEmployees()">
            </ng-select>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <!-- Employee Summary for Selected Week -->
        <div *ngIf="selectedUserId()" class="p-3 border-bottom bg-light">
          <div class="row text-center">
            <div class="col-md-3">
              <div class="fw-bold text-primary fs-5">{{ getTotalAllocatedHours() }}h</div>
              <small class="text-muted">Total Allocated Hours</small>
            </div>
            <div class="col-md-3">
              <div class="fw-bold text-success fs-5">{{ getAvailableHours() }}h</div>
              <small class="text-muted">Available Hours</small>
            </div>
            <div class="col-md-3">
              <div class="fw-bold text-info fs-5">{{ getTotalUtilizedHours() }}h</div>
              <small class="text-muted">Total Utilized Hours</small>
            </div>
            <div class="col-md-3">
              <div class="fw-bold" [class.text-danger]="getUtilizationPercentage() > 100" [class.text-warning]="getUtilizationPercentage() > 80 && getUtilizationPercentage() <= 100" [class.text-success]="getUtilizationPercentage() <= 80">{{ getUtilizationPercentage() }}%</div>
              <small class="text-muted">Capacity Utilization</small>
            </div>
          </div>
          <!-- <div class="mt-2 text-center">
            <small class="text-muted">
              <i class="bi bi-calendar-week me-1"></i>
              Week: {{ formatCurrentWeekStart() }} - {{ formatCurrentWeekEnd() }}
            </small>
          </div> -->
        </div>
        
        <div *ngIf="selectedUserId() && filteredAllocations().length === 0" class="text-center p-4">
          <i class="bi bi-inbox text-muted fs-1"></i>
          <p class="text-muted mt-2 mb-0">No allocations found for this employee</p>
        </div>
        
        <div *ngIf="selectedUserId() && filteredAllocations().length > 0" class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Project</th>
                <th class="text-center">Allocated Hours</th>
                <th class="text-center">Status</th>
                <th *ngIf="canCreateOrEdit()" class="text-center actions-column">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let allocation of filteredAllocations()">
                <td>
                  <div class="fw-medium">{{ allocation.projectName }}</div>
                </td>
                <td class="text-center">{{ allocation.allocatedHours }}h</td>
                <td class="text-center">
                  <span [class]="getStatusBadgeClass(allocation.status)">
                    {{ allocation.status }}
                  </span>
                </td>
                <td *ngIf="canCreateOrEdit()" class="text-center align-middle">
                  <div class="btn-group btn-group-sm" role="group" aria-label="Actions">
                    <button 
                      type="button"
                      class="btn btn-outline-primary" 
                      (click)="openEditModal(allocation)"
                      title="Edit allocation">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button 
                      type="button"
                      class="btn btn-outline-danger" 
                      (click)="deleteAllocation(allocation)"
                      title="Delete allocation">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal fade" [class.show]="showCreateModal()" [style.display]="showCreateModal() ? 'block' : 'none'" 
     tabindex="-1" role="dialog" [attr.aria-hidden]="!showCreateModal()">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ editingAllocation() ? 'Edit Allocation' : 'Create New Allocation' }}
        </h5>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
      </div>
      <form [formGroup]="allocationForm" (ngSubmit)="onSubmit()">
        <div class="modal-body">
          <!-- Project and Week Selection -->
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Project *</label>
                <ng-select 
                  formControlName="projectId"
                  [disabled]="!!editingAllocation()"
                  placeholder="Search and select a project..."
                  [clearable]="false"
                  [searchable]="true"
                  bindLabel="displayName"
                  bindValue="projectId"
                  [items]="availableProjectsWithDisplayName()">
                  <ng-option *ngFor="let project of availableProjectsWithDisplayName()" [value]="project.projectId">
                    <span>{{ project.projectName }} <small class="text-muted">- {{ project.clientName }}</small></span>
                  </ng-option>
                </ng-select>
                <div class="invalid-feedback d-block" 
                     *ngIf="allocationForm.get('projectId')?.invalid && allocationForm.get('projectId')?.touched">
                  Project is required
                </div>
              </div>
            </div>
            
            <div class="col-md-3">
              <div class="mb-3">
                <label class="form-label">Week Start Date *</label>
                <input 
                  type="date" 
                  class="form-control" 
                  formControlName="weekStartDate"
                  [disabled]="!!editingAllocation()"
                  (change)="onWeekStartDateChange($any($event.target).value)">
                <div class="form-text">
                  <small class="text-muted">Select the Sunday that starts the work week</small>
                </div>
                <div class="invalid-feedback d-block" 
                     *ngIf="allocationForm.get('weekStartDate')?.invalid && allocationForm.get('weekStartDate')?.touched">
                  Week start date is required
                </div>
              </div>
            </div>
            
            <div class="col-md-3">
              <div class="mb-3">
                <label class="form-label">Week End Date *</label>
                <input 
                  type="date" 
                  class="form-control" 
                  formControlName="weekEndDate"
                  [disabled]="!!editingAllocation()"
                  (change)="onWeekEndDateChange($any($event.target).value)">
                <div class="form-text">
                  <small class="text-muted">Auto-calculated, but editable if needed</small>
                </div>
                <div class="invalid-feedback d-block" 
                     *ngIf="allocationForm.get('weekEndDate')?.invalid && allocationForm.get('weekEndDate')?.touched">
                  Week end date is required
                </div>
              </div>
            </div>
          </div>

          <!-- Multi-Month Week Detection -->
          <div *ngIf="isMultiMonthWeek() && !editingAllocation()" class="mb-4">
            <div class="alert alert-info d-flex align-items-center">
              <i class="bi bi-info-circle me-2"></i>
              <div class="flex-grow-1">
                <strong>Multi-Month Week Detected!</strong>
                <p class="mb-2">This week spans multiple months. Separate allocations will be created for each month period for more accurate monthly reporting.</p>
                <div class="row g-2">
                  <div class="col-md-12">
                    <strong>Month Periods:</strong>
                    <ul class="mb-0 mt-1">
                      <li *ngFor="let period of monthPeriods()">
                        {{ period.month }}: {{ period.startDate | date:'shortDate' }} - {{ period.endDate | date:'shortDate' }} ({{ period.days }} days)
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Month Period Allocation Note -->
          <div *ngIf="isMultiMonthWeek() && monthPeriods().length > 0 && !editingAllocation()" class="mb-4">
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <strong>Note:</strong> Since this week spans multiple months, separate allocation records will be created for each month period. Each employee will have separate rows for each month period below.
            </div>
          </div>

          <!-- Employee Selection Section -->
          <div *ngIf="!editingAllocation()" class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="mb-0">Employee Allocations</h6>
              <div class="d-flex align-items-center gap-3">
                <ng-select 
                  [ngModel]="selectedEmployeeForDropdown()"
                  (ngModelChange)="onEmployeeAdd($event)"
                  [ngModelOptions]="{standalone: true}"
                  placeholder="Search and select an employee to add..."
                  [clearable]="true"
                  [searchable]="true"
                  bindLabel="userName"
                  bindValue="userId"
                  [items]="availableEmployeesForSelection()"
                  style="width: 300px;">
                  <ng-option *ngFor="let employee of availableEmployeesForSelection()" [value]="employee.userId">
                    <span>{{ employee.userName }} <small class="text-muted">({{ employee.role }})</small></span>
                  </ng-option>
                </ng-select>
              </div>
            </div>

            <!-- Selected Employees Table -->
            <div *ngIf="selectedEmployeeAllocations().length > 0" class="table-responsive">
              <table class="table table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>Employee Name</th>
                    <th *ngIf="isMultiMonthWeek()">Period</th>
                    <th style="width: 200px;">Allocated Hours</th>
                    <th style="width: 100px;" class="text-center">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Standard single week view -->
                  <ng-container *ngIf="!isMultiMonthWeek()">
                    <tr *ngFor="let employee of selectedEmployeeAllocations(); trackBy: trackByUserId">
                      <td>
                        <div class="fw-medium">{{ employee.userName }}</div>
                      </td>
                      <td>
                        <input 
                          type="number" 
                          class="form-control" 
                          [value]="employee.allocatedHours"
                          (input)="updateEmployeeHours(employee.userId, +$any($event.target).value)"
                          min="0" 
                          placeholder="Hours">
                      </td>
                      <td class="text-center">
                        <button 
                          type="button" 
                          class="btn btn-sm btn-outline-danger"
                          (click)="removeEmployeeAllocation(employee.userId)"
                          title="Remove employee">
                          <i class="bi bi-trash"></i>
                        </button>
                      </td>
                    </tr>
                  </ng-container>
                  
                  <!-- Multi-month view with multiple rows per employee -->
                  <ng-container *ngIf="isMultiMonthWeek()">
                    <ng-container *ngFor="let employee of selectedEmployeeAllocations(); trackBy: trackByUserId">
                      <tr *ngFor="let period of monthPeriods(); let periodIndex = index; trackBy: trackByPeriodIndex" 
                          [class.table-secondary]="periodIndex === 0">
                        <td>
                          <div class="fw-medium" *ngIf="periodIndex === 0">{{ employee.userName }}</div>
                          <div *ngIf="periodIndex > 0" class="text-muted" style="padding-left: 20px;">└─ Additional Period</div>
                        </td>
                        <td>
                          <div class="fw-medium">{{ period.month }}</div>
                          <small class="text-muted">{{ period.startDate | date:'shortDate' }} - {{ period.endDate | date:'shortDate' }} ({{ period.days }} days)</small>
                        </td>
                        <td>
                          <input 
                            type="number" 
                            class="form-control" 
                            [value]="getEmployeePeriodHours(employee.userId, periodIndex)"
                            (input)="updateEmployeePeriodHours(employee.userId, periodIndex, +$any($event.target).value)"
                            min="0" 
                            placeholder="Hours">
                          <div class="form-text small">Suggested: {{ Math.round((period.days / 7) * 63) }} hours</div>
                        </td>
                        <td class="text-center">
                          <button 
                            *ngIf="periodIndex === 0"
                            type="button" 
                            class="btn btn-sm btn-outline-danger"
                            (click)="removeEmployeeAllocation(employee.userId)"
                            title="Remove employee">
                            <i class="bi bi-trash"></i>
                          </button>
                        </td>
                      </tr>
                    </ng-container>
                  </ng-container>
                </tbody>
              </table>
            </div>

            <!-- No employees selected message -->
            <div *ngIf="selectedEmployeeAllocations().length === 0" class="text-center p-4 border border-dashed rounded">
              <i class="bi bi-person-plus fs-1 text-muted"></i>
              <p class="text-muted mt-2 mb-0">No employees selected. Use the dropdown above to add employees for allocation.</p>
            </div>
          </div>

          <!-- Edit Mode: Single Employee -->
          <div *ngIf="editingAllocation() && selectedEmployeeAllocations().length > 0" class="mb-4">
            <h6 class="mb-3">Employee Allocation</h6>
            <div class="card">
              <div class="card-body">
                <div class="row align-items-center">
                  <div class="col-md-6">
                    <div class="fw-medium">{{ selectedEmployeeAllocations()[0].userName }}</div>
                    <small class="text-muted">Employee</small>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Allocated Hours</label>
                    <input 
                      type="number" 
                      class="form-control" 
                      [value]="selectedEmployeeAllocations()[0].allocatedHours"
                      (input)="updateEmployeeHours(selectedEmployeeAllocations()[0].userId, +$any($event.target).value)"
                      min="0" 
                      placeholder="Hours">
                    <div class="form-text">Enter allocation hours for this employee</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
          <button 
            type="submit" 
            class="btn btn-primary" 
            [disabled]="allocationForm.invalid || selectedEmployeeAllocations().length === 0">
            {{ editingAllocation() ? 'Update Allocation' : 'Create Allocation(s)' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Export Modal -->
<div class="modal fade" [class.show]="showExportModal()" [style.display]="showExportModal() ? 'block' : 'none'" 
     tabindex="-1" role="dialog" [attr.aria-hidden]="!showExportModal()">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-download me-2"></i>
          Export Allocations
        </h5>
        <button type="button" class="btn-close" (click)="closeExportModal()"></button>
      </div>
      <div class="modal-body">
        <!-- Quick Period Selection -->
        <div class="mb-4">
          <label class="form-label fw-semibold">Quick Period Selection</label>
          <div class="d-flex gap-2 flex-wrap">
            <button 
              class="btn btn-sm" 
              [class.btn-primary]="selectedExportPeriod() === 'prev-month'"
              [class.btn-outline-secondary]="selectedExportPeriod() !== 'prev-month'"
              (click)="setPreviousMonth()" 
              title="Previous Month">
              <i class="bi bi-calendar-minus me-1"></i> Prev Month
            </button>
            <button 
              class="btn btn-sm" 
              [class.btn-primary]="selectedExportPeriod() === 'this-month'"
              [class.btn-outline-secondary]="selectedExportPeriod() !== 'this-month'"
              (click)="setCurrentMonth()" 
              title="Current Month">
              <i class="bi bi-calendar-check me-1"></i> This Month
            </button>
            <button 
              class="btn btn-sm" 
              [class.btn-primary]="selectedExportPeriod() === 'this-quarter'"
              [class.btn-outline-secondary]="selectedExportPeriod() !== 'this-quarter'"
              (click)="setCurrentQuarter()" 
              title="Current Quarter">
              <i class="bi bi-calendar3 me-1"></i> This Quarter
            </button>
          </div>
        </div>

        <!-- Custom Date Range -->
        <div class="mb-4">
          <label class="form-label fw-semibold">Custom Date Range</label>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label small">From Date</label>
              <input 
                type="date" 
                class="form-control" 
                [(ngModel)]="exportFromDate"
                (ngModelChange)="onExportDateChange()"
                [disabled]="isExporting()">
            </div>
            <div class="col-md-6">
              <label class="form-label small">To Date</label>
              <input 
                type="date" 
                class="form-control" 
                [(ngModel)]="exportToDate"
                (ngModelChange)="onExportDateChange()"
                [disabled]="isExporting()">
            </div>
          </div>
        </div>

        <!-- Filter Information -->
        <div class="mb-4">
          <label class="form-label fw-semibold">Export Scope</label>
          <div class="card">
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-12">
                  <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-funnel me-2 text-primary"></i>
                    <strong>Current Filters Applied:</strong>
                  </div>
                  <ul class="list-unstyled mb-0 ms-4">
                    <li><i class="bi bi-calendar-range me-2"></i>Date Range: {{ exportFromDate() }} to {{ exportToDate() }}</li>
                    <li *ngIf="viewMode() === 'project' && selectedProjectId()">
                      <i class="bi bi-briefcase me-2"></i>Project: {{ getSelectedProjectName() }}
                    </li>
                    <li *ngIf="viewMode() === 'project' && !selectedProjectId()">
                      <i class="bi bi-briefcase me-2"></i>All Projects
                    </li>
                    <li *ngIf="viewMode() === 'employee' && selectedUserId()">
                      <i class="bi bi-person me-2"></i>Employee: {{ getSelectedEmployeeName() }}
                    </li>
                    <li *ngIf="viewMode() === 'employee' && !selectedUserId()">
                      <i class="bi bi-people me-2"></i>All Employees
                    </li>
                    <li *ngIf="viewMode() === 'overview'">
                      <i class="bi bi-grid-3x3-gap me-2"></i>Overview: All Projects and Employees
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Export Information -->
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          <strong>Export Details:</strong>
          <ul class="mb-0 mt-2">
            <li><strong>Date Range:</strong> {{ exportFromDate() }} to {{ exportToDate() }}</li>
            <li *ngIf="viewMode() === 'project' && selectedProjectId()"><strong>Filtered by Project:</strong> {{ getSelectedProjectName() }}</li>
            <li *ngIf="viewMode() === 'project' && !selectedProjectId()"><strong>Scope:</strong> All Projects</li>
            <li *ngIf="viewMode() === 'employee' && selectedUserId()"><strong>Filtered by Employee:</strong> {{ getSelectedEmployeeName() }}</li>
            <li *ngIf="viewMode() === 'employee' && !selectedUserId()"><strong>Scope:</strong> All Employees</li>
            <li *ngIf="viewMode() === 'overview'"><strong>Scope:</strong> All Projects and Employees</li>
            <li><strong>Current View:</strong> {{ viewMode() === 'overview' ? 'Overview' : viewMode() === 'project' ? 'Project View' : 'Employee View' }}</li>
          </ul>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeExportModal()">Cancel</button>
        <button 
          type="button"
          class="btn btn-success" 
          (click)="exportToCsvAndClose()" 
          [disabled]="!exportFromDate() || !exportToDate() || isExporting()">
          <span *ngIf="isExporting()" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          <i *ngIf="!isExporting()" class="bi bi-file-earmark-excel me-2"></i>
          {{ isExporting() ? 'Exporting...' : 'Export CSV' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrops -->
<div class="modal-backdrop fade" [class.show]="showCreateModal()" *ngIf="showCreateModal()"></div>
<div class="modal-backdrop fade" [class.show]="showExportModal()" *ngIf="showExportModal()"></div>
</div>
