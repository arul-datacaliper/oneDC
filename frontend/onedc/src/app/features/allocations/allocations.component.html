<div class="allocations-page">
<div class="allocations-container">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">Resource Allocation Management</h2>
      <p class="text-muted mb-0">Manage weekly project allocations for employees</p>
    </div>
    
    <!-- Week Selection and New Allocation -->
    <div class="d-flex align-items-center gap-4">
      <!-- Week Navigation -->
      <div class="d-flex align-items-center gap-3">
        <button class="btn btn-outline-secondary btn-sm" (click)="onWeekChange('prev')" title="Previous Week">
          <i class="bi bi-chevron-left"></i>
        </button>
        
        <!-- From Date -->
        <div class="d-flex flex-column" style="margin-top: -25px;">
          <label class="form-label mb-1 text-muted small">From Date</label>
          <input 
            type="date" 
            class="form-control form-control-sm" 
            [value]="formatCurrentWeekStart()" 
            (change)="onWeekDateChange($event)"
            style="width: 140px;">
        </div>
        
        <!-- To Date -->
        <div class="d-flex flex-column" style="margin-top: -25px;">
          <label class="form-label mb-1 text-muted small">To Date</label>
          <input 
            type="date" 
            class="form-control form-control-sm" 
            [value]="formatCurrentWeekEnd()" 
            readonly
            style="width: 140px; background-color: #f8f9fa;">
        </div>
        
        <button class="btn btn-outline-secondary btn-sm" (click)="onWeekChange('next')" title="Next Week">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
      
      <!-- New Allocation Button -->
      <button class="btn btn-primary" (click)="openCreateModal()">
        <i class="bi bi-plus-circle me-2"></i>
        New Allocation
      </button>
    </div>
  </div>

  <!-- Export Section -->
  <div class="card mb-4">
    <div class="card-header">
      <div class="d-flex justify-content-between align-items-center">
        <h6 class="card-title mb-0">
          <i class="bi bi-download me-2"></i>
          Export Allocations
        </h6>
        <div class="d-flex align-items-center gap-2">
          <button 
            class="btn btn-sm" 
            [class.btn-primary]="selectedExportPeriod() === 'prev-month'"
            [class.btn-outline-secondary]="selectedExportPeriod() !== 'prev-month'"
            (click)="setPreviousMonth()" 
            title="Previous Month">
            <i class="bi bi-calendar-minus"></i> Prev Month
          </button>
          <button 
            class="btn btn-sm" 
            [class.btn-primary]="selectedExportPeriod() === 'this-month'"
            [class.btn-outline-secondary]="selectedExportPeriod() !== 'this-month'"
            (click)="setCurrentMonth()" 
            title="Current Month">
            <i class="bi bi-calendar-check"></i> This Month
          </button>
          <button 
            class="btn btn-sm" 
            [class.btn-primary]="selectedExportPeriod() === 'this-quarter'"
            [class.btn-outline-secondary]="selectedExportPeriod() !== 'this-quarter'"
            (click)="setCurrentQuarter()" 
            title="Current Quarter">
            <i class="bi bi-calendar3"></i> This Quarter
          </button>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-2">
          <label class="form-label small">From Date</label>
          <input 
            type="date" 
            class="form-control form-control-sm" 
            [(ngModel)]="exportFromDate"
            (ngModelChange)="onExportDateChange()"
            [disabled]="isExporting()">
        </div>
        <div class="col-md-2">
          <label class="form-label small">To Date</label>
          <input 
            type="date" 
            class="form-control form-control-sm" 
            [(ngModel)]="exportToDate"
            (ngModelChange)="onExportDateChange()"
            [disabled]="isExporting()">
        </div>
        <div class="col-md-3" *ngIf="viewMode() === 'project'">
          <label class="form-label small">Selected Project</label>
          <div class="form-control form-control-sm bg-light">
            {{ getSelectedProjectName() || 'All Projects' }}
          </div>
        </div>
        <div class="col-md-3" *ngIf="viewMode() === 'employee'">
          <label class="form-label small">Selected Employee</label>
          <div class="form-control form-control-sm bg-light">
            {{ getSelectedEmployeeName() || 'All Employees' }}
          </div>
        </div>
        <div class="col-md-2">
          <button 
            class="btn btn-success btn-sm w-100" 
            (click)="exportToCsv()" 
            [disabled]="!exportFromDate() || !exportToDate() || isExporting()">
            <span *ngIf="isExporting()" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            <i *ngIf="!isExporting()" class="bi bi-file-earmark-excel me-2"></i>
            {{ isExporting() ? 'Exporting...' : 'Export CSV' }}
          </button>
        </div>
      </div>
      <div class="mt-2">
        <small class="text-muted">
          <i class="bi bi-info-circle me-1"></i>
          Export allocations for the selected date range
          <span *ngIf="viewMode() === 'project' && selectedProjectId()"> for the selected project</span>
          <span *ngIf="viewMode() === 'employee' && selectedUserId()"> for the selected employee</span>
        </small>
      </div>
    </div>
  </div>

  <!-- View Mode Tabs -->
  <div class="card mb-4">
    <div class="card-header border-bottom-0">
      <ul class="nav nav-tabs card-header-tabs">
        <li class="nav-item">
          <button 
            class="nav-link"
            [class.active]="viewMode() === 'overview'"
            (click)="onViewModeChange('overview')">
            <i class="bi bi-grid-3x3-gap me-2"></i>
            Overview
          </button>
        </li>
        <li class="nav-item">
          <button 
            class="nav-link"
            [class.active]="viewMode() === 'project'"
            (click)="onViewModeChange('project')">
            <i class="bi bi-briefcase me-2"></i>
            By Project
          </button>
        </li>
        <li class="nav-item">
          <button 
            class="nav-link"
            [class.active]="viewMode() === 'employee'"
            (click)="onViewModeChange('employee')">
            <i class="bi bi-people me-2"></i>
            By Employee
          </button>
        </li>
      </ul>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading()" class="text-center p-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Overview Mode -->
  <div *ngIf="!isLoading() && viewMode() === 'overview'">
    <!-- Project Summary -->
    <div class="row">
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header">
            <h6 class="card-title mb-0">Projects Summary</h6>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Project</th>
                    <th class="text-center">Employees</th>
                    <th class="text-center">Hours</th>
                    <th class="text-center">Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let project of projectSummary()">
                    <td>
                      <div class="fw-medium">{{ project.projectName }}</div>
                      <small class="text-muted">{{ project.utilizationPercentage }}% utilized</small>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-secondary">{{ project.totalEmployees }}</span>
                    </td>
                    <td class="text-center">{{ project.totalAllocatedHours }}h</td>
                    <td class="text-center">
                      <button 
                        class="btn btn-sm btn-outline-primary"
                        (click)="onProjectSelect(project.projectId)">
                        View Details
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header">
            <h6 class="card-title mb-0">Employees Summary</h6>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Employee</th>
                    <th class="text-center">Projects</th>
                    <th class="text-center">Hours</th>
                    <th class="text-center">Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let employee of employeeSummary()">
                    <td>
                      <div class="fw-medium">{{ employee.userName }}</div>
                      <small class="text-muted">{{ employee.utilizationPercentage }}% capacity</small>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-info">{{ employee.totalProjects }}</span>
                    </td>
                    <td class="text-center">{{ employee.totalAllocatedHours }}h</td>
                    <td class="text-center">
                      <button 
                        class="btn btn-sm btn-outline-primary"
                        (click)="onEmployeeSelect(employee.userId)">
                        View Details
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Project View Mode -->
  <div *ngIf="!isLoading() && viewMode() === 'project'">
    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="card-title mb-0">Project Allocations</h6>
          <div style="width: 300px;">
            <ng-select 
              [ngModel]="selectedProjectId()" 
              (ngModelChange)="onProjectSelect($event)"
              placeholder="Search and select a project..."
              [clearable]="true"
              [searchable]="true"
              bindLabel="displayName"
              bindValue="projectId"
              [items]="availableProjectsWithDisplayName()">
              <ng-option *ngFor="let project of availableProjectsWithDisplayName()" [value]="project.projectId">
                <span>{{ project.projectName }} <small class="text-muted">- {{ project.clientName }}</small></span>
              </ng-option>
            </ng-select>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <div *ngIf="selectedProjectId() && filteredAllocations().length === 0" class="text-center p-4">
          <i class="bi bi-inbox text-muted fs-1"></i>
          <p class="text-muted mt-2 mb-0">No allocations found for this project</p>
        </div>
        
        <div *ngIf="selectedProjectId() && filteredAllocations().length > 0" class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Employee</th>
                <th class="text-center">Allocated Hours</th>
                <th class="text-center">Utilization</th>
                <th class="text-center">Status</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let allocation of filteredAllocations()">
                <td>
                  <div class="fw-medium">{{ allocation.userName }}</div>
                  <small class="text-muted">{{ allocation.weekStartDate | date:'shortDate' }} - {{ allocation.weekEndDate | date:'shortDate' }}</small>
                </td>
                <td class="text-center">{{ allocation.allocatedHours }}h</td>
                <td class="text-center">
                  <span [class]="getUtilizationBadgeClass(allocation.utilizationPercentage)">
                    {{ allocation.utilizationPercentage }}%
                  </span>
                </td>
                <td class="text-center">
                  <span [class]="getStatusBadgeClass(allocation.status)">
                    {{ allocation.status }}
                  </span>
                </td>
                <td class="text-center">
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" (click)="openEditModal(allocation)">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-danger" (click)="deleteAllocation(allocation)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Employee View Mode -->
  <div *ngIf="!isLoading() && viewMode() === 'employee'">
    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="card-title mb-0">Employee Allocations</h6>
          <div style="width: 300px;">
            <ng-select 
              [ngModel]="selectedUserId()" 
              (ngModelChange)="onEmployeeSelect($event)"
              placeholder="Search and select an employee..."
              [clearable]="true"
              [searchable]="true"
              bindLabel="userName"
              bindValue="userId"
              [items]="availableEmployees()">
            </ng-select>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <div *ngIf="selectedUserId() && filteredAllocations().length === 0" class="text-center p-4">
          <i class="bi bi-inbox text-muted fs-1"></i>
          <p class="text-muted mt-2 mb-0">No allocations found for this employee</p>
        </div>
        
        <div *ngIf="selectedUserId() && filteredAllocations().length > 0" class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Project</th>
                <th class="text-center">Allocated Hours</th>
                <th class="text-center">Utilization</th>
                <th class="text-center">Status</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let allocation of filteredAllocations()">
                <td>
                  <div class="fw-medium">{{ allocation.projectName }}</div>
                  <small class="text-muted">{{ allocation.weekStartDate | date:'shortDate' }} - {{ allocation.weekEndDate | date:'shortDate' }}</small>
                </td>
                <td class="text-center">{{ allocation.allocatedHours }}h</td>
                <td class="text-center">
                  <span [class]="getUtilizationBadgeClass(allocation.utilizationPercentage)">
                    {{ allocation.utilizationPercentage }}%
                  </span>
                </td>
                <td class="text-center">
                  <span [class]="getStatusBadgeClass(allocation.status)">
                    {{ allocation.status }}
                  </span>
                </td>
                <td class="text-center">
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" (click)="openEditModal(allocation)">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-danger" (click)="deleteAllocation(allocation)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal fade" [class.show]="showCreateModal()" [style.display]="showCreateModal() ? 'block' : 'none'" 
     tabindex="-1" role="dialog" [attr.aria-hidden]="!showCreateModal()">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ editingAllocation() ? 'Edit Allocation' : 'Create New Allocation' }}
        </h5>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
      </div>
      <form [formGroup]="allocationForm" (ngSubmit)="onSubmit()">
        <div class="modal-body">
          <!-- Project and Week Selection -->
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Project *</label>
                <ng-select 
                  formControlName="projectId"
                  [disabled]="!!editingAllocation()"
                  placeholder="Search and select a project..."
                  [clearable]="false"
                  [searchable]="true"
                  bindLabel="displayName"
                  bindValue="projectId"
                  [items]="availableProjectsWithDisplayName()">
                  <ng-option *ngFor="let project of availableProjectsWithDisplayName()" [value]="project.projectId">
                    <span>{{ project.projectName }} <small class="text-muted">- {{ project.clientName }}</small></span>
                  </ng-option>
                </ng-select>
                <div class="invalid-feedback d-block" 
                     *ngIf="allocationForm.get('projectId')?.invalid && allocationForm.get('projectId')?.touched">
                  Project is required
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Week Start Date *</label>
                <input 
                  type="date" 
                  class="form-control" 
                  formControlName="weekStartDate"
                  [disabled]="!!editingAllocation()"
                  (change)="onWeekStartDateChange($any($event.target).value)">
                <div class="form-text">
                  <!-- Select the Sunday that starts the work week -->
                  <div *ngIf="allocationForm.get('weekStartDate')?.value" class="mt-1">
                    <small class="text-primary">
                      Week: {{ allocationForm.get('weekStartDate')?.value | date:'mediumDate' }} - 
                      {{ selectedWeekEndDate() | date:'mediumDate' }}
                    </small>
                  </div>
                </div>
                <div class="invalid-feedback d-block" 
                     *ngIf="allocationForm.get('weekStartDate')?.invalid && allocationForm.get('weekStartDate')?.touched">
                  Week start date is required
                </div>
              </div>
            </div>
          </div>

          <!-- Multi-Month Week Detection -->
          <div *ngIf="isMultiMonthWeek() && !editingAllocation()" class="mb-4">
            <div class="alert alert-info d-flex align-items-center">
              <i class="bi bi-info-circle me-2"></i>
              <div class="flex-grow-1">
                <strong>Multi-Month Week Detected!</strong>
                <p class="mb-2">This week spans multiple months. Separate allocations will be created for each month period for more accurate monthly reporting.</p>
                <div class="row g-2">
                  <div class="col-md-12">
                    <strong>Month Periods:</strong>
                    <ul class="mb-0 mt-1">
                      <li *ngFor="let period of monthPeriods()">
                        {{ period.month }}: {{ period.startDate | date:'shortDate' }} - {{ period.endDate | date:'shortDate' }} ({{ period.days }} days)
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Month Period Allocation Note -->
          <div *ngIf="isMultiMonthWeek() && monthPeriods().length > 0 && !editingAllocation()" class="mb-4">
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <strong>Note:</strong> Since this week spans multiple months, separate allocation records will be created for each month period. Each employee will have separate rows for each month period below.
            </div>
          </div>

          <!-- Employee Selection Section -->
          <div *ngIf="!editingAllocation()" class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="mb-0">Employee Allocations</h6>
              <div class="d-flex align-items-center gap-3">
                <ng-select 
                  [ngModel]="selectedEmployeeForDropdown()"
                  (ngModelChange)="onEmployeeAdd($event)"
                  [ngModelOptions]="{standalone: true}"
                  placeholder="Search and select an employee to add..."
                  [clearable]="true"
                  [searchable]="true"
                  bindLabel="userName"
                  bindValue="userId"
                  [items]="availableEmployeesForSelection()"
                  style="width: 300px;">
                  <ng-option *ngFor="let employee of availableEmployeesForSelection()" [value]="employee.userId">
                    <span>{{ employee.userName }} <small class="text-muted">({{ employee.role }})</small></span>
                  </ng-option>
                </ng-select>
              </div>
            </div>

            <!-- Selected Employees Table -->
            <div *ngIf="selectedEmployeeAllocations().length > 0" class="table-responsive">
              <table class="table table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>Employee Name</th>
                    <th *ngIf="isMultiMonthWeek()">Period</th>
                    <th style="width: 200px;">Allocated Hours</th>
                    <th style="width: 100px;" class="text-center">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Standard single week view -->
                  <ng-container *ngIf="!isMultiMonthWeek()">
                    <tr *ngFor="let employee of selectedEmployeeAllocations(); trackBy: trackByUserId">
                      <td>
                        <div class="fw-medium">{{ employee.userName }}</div>
                      </td>
                      <td>
                        <input 
                          type="number" 
                          class="form-control" 
                          [value]="employee.allocatedHours"
                          (input)="updateEmployeeHours(employee.userId, +$any($event.target).value)"
                          min="0" 
                          placeholder="Hours">
                      </td>
                      <td class="text-center">
                        <button 
                          type="button" 
                          class="btn btn-sm btn-outline-danger"
                          (click)="removeEmployeeAllocation(employee.userId)"
                          title="Remove employee">
                          <i class="bi bi-trash"></i>
                        </button>
                      </td>
                    </tr>
                  </ng-container>
                  
                  <!-- Multi-month view with multiple rows per employee -->
                  <ng-container *ngIf="isMultiMonthWeek()">
                    <ng-container *ngFor="let employee of selectedEmployeeAllocations(); trackBy: trackByUserId">
                      <tr *ngFor="let period of monthPeriods(); let periodIndex = index; trackBy: trackByPeriodIndex" 
                          [class.table-secondary]="periodIndex === 0">
                        <td>
                          <div class="fw-medium" *ngIf="periodIndex === 0">{{ employee.userName }}</div>
                          <div *ngIf="periodIndex > 0" class="text-muted" style="padding-left: 20px;">└─ Additional Period</div>
                        </td>
                        <td>
                          <div class="fw-medium">{{ period.month }}</div>
                          <small class="text-muted">{{ period.startDate | date:'shortDate' }} - {{ period.endDate | date:'shortDate' }} ({{ period.days }} days)</small>
                        </td>
                        <td>
                          <input 
                            type="number" 
                            class="form-control" 
                            [value]="getEmployeePeriodHours(employee.userId, periodIndex)"
                            (input)="updateEmployeePeriodHours(employee.userId, periodIndex, +$any($event.target).value)"
                            min="0" 
                            placeholder="Hours">
                          <div class="form-text small">Suggested: {{ Math.round((period.days / 7) * 40) }} hours</div>
                        </td>
                        <td class="text-center">
                          <button 
                            *ngIf="periodIndex === 0"
                            type="button" 
                            class="btn btn-sm btn-outline-danger"
                            (click)="removeEmployeeAllocation(employee.userId)"
                            title="Remove employee">
                            <i class="bi bi-trash"></i>
                          </button>
                        </td>
                      </tr>
                    </ng-container>
                  </ng-container>
                </tbody>
              </table>
            </div>

            <!-- No employees selected message -->
            <div *ngIf="selectedEmployeeAllocations().length === 0" class="text-center p-4 border border-dashed rounded">
              <i class="bi bi-person-plus fs-1 text-muted"></i>
              <p class="text-muted mt-2 mb-0">No employees selected. Use the dropdown above to add employees for allocation.</p>
            </div>
          </div>

          <!-- Edit Mode: Single Employee -->
          <div *ngIf="editingAllocation() && selectedEmployeeAllocations().length > 0" class="mb-4">
            <h6 class="mb-3">Employee Allocation</h6>
            <div class="card">
              <div class="card-body">
                <div class="row align-items-center">
                  <div class="col-md-6">
                    <div class="fw-medium">{{ selectedEmployeeAllocations()[0].userName }}</div>
                    <small class="text-muted">Employee</small>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Allocated Hours</label>
                    <input 
                      type="number" 
                      class="form-control" 
                      [value]="selectedEmployeeAllocations()[0].allocatedHours"
                      (input)="updateEmployeeHours(selectedEmployeeAllocations()[0].userId, +$any($event.target).value)"
                      min="0" 
                      placeholder="Hours">
                    <div class="form-text">Enter allocation hours for this employee</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
          <button 
            type="submit" 
            class="btn btn-primary" 
            [disabled]="allocationForm.invalid || selectedEmployeeAllocations().length === 0">
            {{ editingAllocation() ? 'Update Allocation' : 'Create Allocation(s)' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade" [class.show]="showCreateModal()" *ngIf="showCreateModal()"></div>
</div>
