<div class="timesheet-editor-page">
<div class="card">
  <div class="card-body">
    <div class="header-row">
      <div class="left">
        <button type="button" class="btn btn-outline-primary" (click)="prevDay()">
          <i class="bi bi-chevron-left"></i> Prev
        </button>
        <div class="range">
          <div class="label">Date</div>
          <div class="value">{{ selectedDate() }}</div>
        </div>
        <button type="button" class="btn btn-outline-primary" (click)="nextDay()" 
                [disabled]="isNextDayFuture()" 
                [title]="isNextDayFuture() ? 'Cannot navigate to future dates' : 'Next day'">
          Next <i class="bi bi-chevron-right"></i>
        </button>
      </div>

      <div class="right">
        <button type="button" class="btn btn-outline-secondary btn-sm" (click)="load()" 
                title="Refresh timesheet entries" [disabled]="loading()">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
        <div class="total">
          <i class="bi bi-calculator"></i>
          <span>Total: {{ dailyTotal() | number:'1.0-2' }} h</span>
        </div>
      </div>
    </div>

    <hr>

    <!-- Admin Controls -->
    <div *ngIf="isAdmin()" class="admin-controls mb-4">
      <div class="d-flex align-items-center gap-3">
        <div class="admin-badge">
          <i class="bi bi-shield-check"></i>
          <span>Admin View</span>
        </div>
        
        <div class="filter-controls d-flex gap-3 align-items-center">
          <div class="filter-group">
            <label class="form-label small mb-1">View by Employee:</label>
            <app-searchable-dropdown 
              [ngModel]="selectedUserId()" 
              (ngModelChange)="onUserSelectionChange($event)"
              [options]="userOptions()"
              placeholder="All employees"
              [allowEmpty]="true"
              emptyLabel="All employees"
              noResultsText="No employees found"
              [searchFields]="['label', 'searchableText']"
              [style.minWidth.px]="200">
            </app-searchable-dropdown>
          </div>
          
          <div class="filter-separator">OR</div>
          
          <div class="filter-group">
            <label class="form-label small mb-1">View by Project:</label>
            <app-searchable-dropdown 
              [ngModel]="selectedProjectId()" 
              (ngModelChange)="onProjectFilterChange($event)"
              [options]="projectFilterOptions()"
              placeholder="All projects"
              [allowEmpty]="true"
              emptyLabel="All projects"
              noResultsText="No projects found"
              [searchFields]="['label', 'searchableText']"
              [style.minWidth.px]="200">
            </app-searchable-dropdown>
          </div>
          
          <button type="button" class="btn btn-outline-secondary btn-sm" 
                  (click)="clearFilters()" 
                  title="Clear all filters"
                  [disabled]="!selectedUserId() && !selectedProjectId()">
            <i class="bi bi-x-circle"></i> Clear
          </button>
        </div>
      </div>
      <hr class="mt-3">
    </div>

    <div class="new-row">
      <div class="title">
        <i class="bi bi-plus-circle-fill"></i> New entry
      </div>
      <div class="row g-3 align-items-end">
        <div class="col-md-2">
          <label class="form-label">Date</label>
          <input type="date" class="form-control" [formControl]="newRow.controls.workDate" 
                 [max]="getTodayDateString()"
                 (change)="onDateChange($event)"
                 [class.is-invalid]="newRow.controls.workDate.invalid && newRow.controls.workDate.touched" />
          <div class="invalid-feedback" *ngIf="newRow.controls.workDate.invalid && newRow.controls.workDate.touched">
            <div *ngIf="newRow.controls.workDate.errors?.['futureDate']">
              {{ newRow.controls.workDate.errors?.['futureDate'].message }}
            </div>
            <div *ngIf="newRow.controls.workDate.errors?.['required']">
              Date is required
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <label class="form-label">Project *</label>
          <app-searchable-dropdown 
            [formControl]="newRow.controls.projectId"
            [options]="projectOptions()"
            placeholder="Search for project..."
            [allowEmpty]="true"
            emptyLabel="Select project"
            noResultsText="No projects found"
            [searchFields]="['label', 'searchableText']">
          </app-searchable-dropdown>
        </div>

        <div class="col-md-3" *ngIf="newRow.get('projectId')?.value">
          <label class="form-label">Task</label>
          <app-searchable-dropdown 
            [formControl]="newRow.controls.taskId"
            [options]="taskOptions()"
            placeholder="Search for task..."
            [allowEmpty]="true"
            emptyLabel="-- None --"
            noResultsText="No tasks found"
            [searchFields]="['label', 'searchableText']">
          </app-searchable-dropdown>
        </div>

        <div class="col-md-2">
          <label class="form-label">Hours</label>
          <input type="number" class="form-control" min="0" max="24" step="0.25" 
                 [formControl]="newRow.controls.hours" />
          <div *ngIf="dailyTotal() + (newRow.get('hours')?.value || 0) > 12" class="text-danger small mt-1">
            Daily limit exceeded! ({{ dailyTotal() + (newRow.get('hours')?.value || 0) | number:'1.1-2' }}h > 12h)
          </div>
        </div>

        <div class="col-md-2">
          <label class="form-label">Task Type *</label>
          <select class="form-select" [formControl]="newRow.controls.taskType"
                  [class.is-invalid]="newRow.controls.taskType.invalid && newRow.controls.taskType.touched">
            <option value="" disabled>Select task type</option>
            <option *ngFor="let type of taskTypes" [value]="type.value">
              {{ type.label }}
            </option>
          </select>
          <div class="invalid-feedback" *ngIf="newRow.controls.taskType.invalid && newRow.controls.taskType.touched">
            <div *ngIf="newRow.controls.taskType.errors?.['required']">
              Task type is required
            </div>
          </div>
        </div>

        <div class="col-md-2">
          <label class="form-label">Description</label>
          <input type="text" class="form-control" [formControl]="newRow.controls.description" />
        </div>

        <div class="col-md-1">
          <label class="form-label">Ticket</label>
          <input type="text" class="form-control" [formControl]="newRow.controls.ticketRef" />
        </div>

        <div class="col-md-1">
          <button type="button" class="btn btn-primary w-100" (click)="addRow()" [disabled]="submitting()">
            <span *ngIf="submitting()" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            <i *ngIf="!submitting()" class="bi bi-plus-circle"></i> 
            {{ submitting() ? 'Adding...' : 'Add' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card mt-3">
  <div class="card-body">
    <div class="table-header">
      <h5 class="card-title">Timesheet Entries</h5>
      <div class="loading-indicator" *ngIf="loading()">
        <div class="spinner-border spinner-border-sm me-2" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <span>Loading entries...</span>
      </div>
    </div>

    <div *ngIf="!loading() && items.controls.length === 0" class="empty-state text-center py-5">
      <i class="bi bi-clock-history display-1 text-muted"></i>
      <p class="text-muted mt-3">No timesheet entries for this date yet.</p>
      <p class="text-muted">Use the form above to add your first entry.</p>
    </div>

    <div class="table-responsive table-dropdown-friendly" *ngIf="!loading() && items.controls.length > 0">
      <table class="table table-hover">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Project</th>
            <th>Task</th>
            <th>Hours</th>
            <th>Task Type</th>
            <th>Description</th>
            <th>Ticket</th>
            <th>Status</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let g of items.controls; let i = index" [class.editing-row]="isRowInEditMode(i)">
            <td>{{ g.get('workDate')!.value }}</td>
            <td>
              <code class="text-dark">{{ projectLabel(g.get('projectId')!.value) }}</code>
            </td>
            <td>
              <!-- Display mode: Show as text input (read-only) -->
              <input *ngIf="!isRowInEditMode(i)"
                     type="text"
                     class="form-control form-control-sm"
                     [value]="getTaskTitle(g.get('projectId')!.value, g.get('taskId')!.value)"
                     readonly
                     style="border: none; background: transparent; padding: 0; box-shadow: none;"
                     placeholder="No task selected">
              
              <!-- Edit mode: Show as searchable dropdown -->
              <div *ngIf="isRowInEditMode(i)" class="task-dropdown-wrapper">
                <app-searchable-dropdown 
                        [options]="getTaskOptionsForProject(g.get('projectId')!.value)"
                        [formControl]="$any(g.get('taskId'))"
                        placeholder="Search for task..."
                        [allowEmpty]="true"
                        emptyLabel="-- None --"
                        noResultsText="No tasks found"
                        [searchFields]="['label', 'searchableText']">
                </app-searchable-dropdown>
              </div>
            </td>
            <td>
              <input [readonly]="!isRowInEditMode(i)"
                     class="form-control form-control-sm"
                     type="number" min="0" max="24" step="0.25"
                     [value]="g.get('hours')!.value"
                     (input)="onFieldChange(g, 'hours', $any($event.target).value)" />
            </td>
            <td>
              <select [disabled]="!isRowInEditMode(i)"
                      class="form-select form-select-sm"
                      [value]="g.get('taskType')!.value"
                      (change)="onFieldChange(g, 'taskType', +$any($event.target).value)">
                <option *ngFor="let type of taskTypes" [value]="type.value">
                  {{ type.label }}
                </option>
              </select>
            </td>
            <td>
              <input [readonly]="!isRowInEditMode(i)"
                     class="form-control form-control-sm" 
                     [value]="g.get('description')!.value"
                     (input)="onFieldChange(g, 'description', $any($event.target).value)" />
            </td>
            <td>
              <input [readonly]="!isRowInEditMode(i)"
                     class="form-control form-control-sm" 
                     [value]="g.get('ticketRef')!.value"
                     (input)="onFieldChange(g, 'ticketRef', $any($event.target).value)" />
            </td>
            <td>
              <span class="badge" [ngClass]="statusClass(g.get('status')!.value)">
                {{ statusLabel(g.get('status')!.value) }}
              </span>
            </td>
            <td class="text-center actions-cell">
              <div class="d-flex align-items-center justify-content-center gap-1">
                <!-- Edit button - only show when not in edit mode and entry is editable -->
                <button *ngIf="!isRowInEditMode(i) && isEditable(g.get('status')!.value)" 
                        type="button" class="btn btn-outline-secondary btn-sm" (click)="enterEditMode(i)"
                        title="Edit entry">
                  <i class="bi bi-pencil"></i>
                </button>
                
                <!-- Cancel button - only show when in edit mode -->
                <button *ngIf="isRowInEditMode(i)" 
                        type="button" class="btn btn-outline-secondary btn-sm" (click)="exitEditMode()"
                        title="Cancel editing">
                  <i class="bi bi-x"></i>
                </button>
                
                <!-- Save button - only show when in edit mode -->
                <button *ngIf="isRowInEditMode(i)" 
                        type="button" class="btn btn-outline-primary btn-sm" (click)="saveRow(i)"
                        [disabled]="!g.get('dirty')!.value"
                        title="Save changes">
                  <i class="bi bi-save"></i>
                </button>
                
                <!-- Submit button - only show when not in edit mode -->
                <button *ngIf="!isRowInEditMode(i)" 
                        type="button" class="btn btn-outline-success btn-sm" (click)="submitRow(i)"
                        [disabled]="!isEditable(g.get('status')!.value) || g.get('dirty')!.value"
                        title="Submit for approval (save changes first)">
                  <i class="bi bi-send"></i>
                </button>
                
                <!-- Delete button - always show if entry is editable -->
                <button type="button" class="btn btn-outline-danger btn-sm" (click)="deleteRow(i)"
                        [disabled]="!isEditable(g.get('status')!.value)" 
                        title="Delete entry">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
</div>
