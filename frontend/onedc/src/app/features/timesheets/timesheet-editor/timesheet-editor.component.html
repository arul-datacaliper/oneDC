
<mat-card class="header-card">
  <div class="header-row">
    <div class="left">
      <button type="button" class="btn btn-outline-primary" (click)="prevDay()">
        <i class="bi bi-chevron-left"></i> Prev
      </button>
      <div class="range">
        <div class="label">Date</div>
        <div class="value">{{ selectedDate() }}</div>
      </div>
      <button type="button" class="btn btn-outline-primary" (click)="nextDay()">
        Next <i class="bi bi-chevron-right"></i>
      </button>
    </div>

    <div class="right">
      <button type="button" class="btn btn-outline-secondary btn-sm" (click)="load()" 
              title="Refresh timesheet entries" [disabled]="loading()">
        <i class="bi bi-arrow-clockwise"></i>
      </button>
      <div class="total">
        <i class="bi bi-calculator"></i>
        <span>Total: {{ dailyTotal() | number:'1.0-2' }} h</span>
      </div>
    </div>
  </div>

  <mat-divider></mat-divider>

  <div class="new-row">
    <div class="title">
      <i class="bi bi-plus-circle-fill"></i> New entry
    </div>
    <div class="fields">
      <mat-form-field appearance="outline">
        <mat-label>Date</mat-label>
        <input matInput [matDatepicker]="dp" [formControl]="newRow.controls.workDate" />
        <mat-datepicker-toggle matSuffix [for]="dp"></mat-datepicker-toggle>
        <mat-datepicker #dp></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Project</mat-label>
        <mat-select [formControl]="newRow.controls.projectId">
          <mat-option *ngFor="let p of projects()" [value]="p.projectId">
            {{ p.code }} â€” {{ p.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Hours</mat-label>
        <input matInput type="number" min="0" max="24" step="0.25" [formControl]="newRow.controls.hours" />
        <mat-error *ngIf="dailyTotal() + (newRow.get('hours')?.value || 0) > 12">
          Daily limit exceeded! ({{ dailyTotal() + (newRow.get('hours')?.value || 0) | number:'1.1-2' }}h > 12h)
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="grow">
        <mat-label>Description</mat-label>
        <input matInput [formControl]="newRow.controls.description" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Ticket</mat-label>
        <input matInput [formControl]="newRow.controls.ticketRef" />
      </mat-form-field>

      <button type="button" class="btn btn-primary" (click)="addRow()">
        <i class="bi bi-plus-circle"></i>&nbsp;Add
      </button>
    </div>
  </div>
</mat-card>

<mat-card class="table-card mt">
  <div class="table-header">
    <h3>Timesheet Entries</h3>
    <div class="loading-indicator" *ngIf="loading()">
      <mat-spinner diameter="20"></mat-spinner>
      <span>Loading entries...</span>
    </div>
  </div>

  <div *ngIf="!loading() && items.controls.length === 0" class="empty-state">
    <i class="bi bi-clock-history display-1 text-muted"></i>
    <p>No timesheet entries for this date yet.</p>
    <p>Use the form above to add your first entry.</p>
  </div>

  <table mat-table [dataSource]="items.controls" class="ts-table" *ngIf="!loading() && items.controls.length > 0">

    <ng-container matColumnDef="date">
      <th mat-header-cell *matHeaderCellDef> Date </th>
      <td mat-cell *matCellDef="let g">
        {{ g.get('workDate')!.value }}
      </td>
    </ng-container>

    <ng-container matColumnDef="project">
      <th mat-header-cell *matHeaderCellDef> Project </th>
      <td mat-cell *matCellDef="let g">
        <div class="mono">{{ projectLabel(g.get('projectId')!.value) }}</div>
      </td>
    </ng-container>

    <ng-container matColumnDef="hours">
      <th mat-header-cell *matHeaderCellDef> Hours </th>
      <td mat-cell *matCellDef="let g; let i = index">
        <input [readonly]="!isDraft(g.get('status')!.value)"
               class="hours-input"
               type="number" min="0" max="24" step="0.25"
               [formControl]="g.get('hours')" />
      </td>
    </ng-container>

    <ng-container matColumnDef="description">
      <th mat-header-cell *matHeaderCellDef> Description </th>
      <td mat-cell *matCellDef="let g">
        <input [readonly]="!isDraft(g.get('status')!.value)"
               class="desc-input" [formControl]="g.get('description')" />
      </td>
    </ng-container>

    <ng-container matColumnDef="ticket">
      <th mat-header-cell *matHeaderCellDef> Ticket </th>
      <td mat-cell *matCellDef="let g">
        <input [readonly]="!isDraft(g.get('status')!.value)"
               class="ticket-input" [formControl]="g.get('ticketRef')" />
      </td>
    </ng-container>

    <ng-container matColumnDef="status">
  <th mat-header-cell *matHeaderCellDef> Status </th>
  <td mat-cell *matCellDef="let g">
    <span class="status-badge" [ngClass]="statusClass(g.get('status')!.value)">
      {{ statusLabel(g.get('status')!.value) }}
    </span>
  </td>
</ng-container>


    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef> Actions </th>
      <td mat-cell *matCellDef="let g; let i = index" class="actions">
        <button type="button" class="btn btn-outline-primary btn-sm" (click)="saveRow(i)"
                [disabled]="!isDraft(g.get('status')!.value) || !g.get('dirty')!.value"
                matTooltip="Save changes">
          <i class="bi bi-save"></i>
        </button>
        <button type="button" class="btn btn-outline-success btn-sm" (click)="submitRow(i)"
                [disabled]="!isDraft(g.get('status')!.value)"
                matTooltip="Submit for approval">
          <i class="bi bi-send"></i>
        </button>
        <button type="button" class="btn btn-outline-danger btn-sm" (click)="deleteRow(i)"
                [disabled]="!isDraft(g.get('status')!.value)" 
                matTooltip="Delete entry">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    </ng-container>    <tr mat-header-row *matHeaderRowDef="displayed"></tr>
    <tr mat-row *matRowDef="let r; columns: displayed;"></tr>
  </table>
</mat-card>
